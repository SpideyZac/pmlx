<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PMLX Updater</title>

        <!-- Check for updates -->
        <script>
            /**
             * Fetches the latest release version from GitHub.
             * @throws {Error} If the network response is not ok.
             * @returns {Promise<string>} The latest release version.
             */
            async function getLatestRelease() {
                try {
                    // const response = await fetch(
                    //     "https://api.github.com/repos/SpideyZac/pmlx/releases/latest"
                    // );
                    return "some-version";
                    if (!response.ok)
                        throw new Error("Network response was not ok");
                    const data = await response.json();
                    return data.tag_name;
                } catch (error) {
                    console.error(
                        "[PMLX Updater] Error fetching latest release:",
                        error
                    );
                    return null;
                }
            }

            /**
             * Gets the current version from the indexedDB.
             * @returns {Promise<string|null>} The current version or null if not found.
             */
            function loadVersion() {
                return new Promise((resolve) => {
                    const request = indexedDB.open("pmlx", 1);
                    request.onsuccess = (event) => {
                        try {
                            const db = event.target.result;
                            const transaction = db.transaction(
                                ["version"],
                                "readonly"
                            );
                            const store = transaction.objectStore("version");
                            const getRequest = store.get("version");
                            getRequest.onsuccess = () => resolve(getRequest.result);
                            getRequest.onerror = () => resolve(null);
                        } catch (_) {
                            resolve(null);
                        }
                    };
                    request.onerror = () => resolve(null);
                });
            }

            /**
             * Checks if the game needs to be updated.
             * @returns {Promise<boolean>} True if an update is needed, false otherwise.
             */
            async function needsUpdate() {
                const latestVersion = await getLatestRelease();
                if (!latestVersion) return false;

                const currentVersion = await loadVersion();
                // If the current version is not found, the game has not been downloaded, so we need to update.
                if (!currentVersion) return true;

                return latestVersion !== currentVersion;
            }

            const isRelease = true;

            // TODO: maybe add a public-index + lib-index
            const stuffToDownload = [
                isRelease ? "release-pmlx.bundle.js" : "debug-pmlx.bundle.js",
                "core-index.json",
                "patches-index.json",
                "sw.js",
                "launcher.html",
            ];

            /**
             * Downloads a file from the specified URL and stores it in indexedDB.
             * @throws {Error} If the network response is not ok.
             * @param {string} file - The name of the file to download.
             */
            async function downloadFile(file) {
                try {
                    // const baseUrl = "https://github.com/SpideyZac/pmlx/releases/latest/download";
                    const baseUrl =
                        "https://raw.githubusercontent.com/SpideyZac/pmlx/refs/heads/master";
                    // this is just for test code
                    var response;
                    if (file.endsWith("pmlx.bundle.js")) {
                        response = await fetch(`${baseUrl}/src/index.ts`);
                    } else {
                        response = await fetch(`${baseUrl}/${file}`);
                    }
                    if (!response.ok) {
                        console.error(
                            `[PMLX Updater] Failed to download ${file}`
                        );
                        return;
                    }
                    const blob = await response.blob();
                    const request = indexedDB.open("pmlx", 1);
                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(
                            ["files"],
                            "readwrite"
                        );
                        const store = transaction.objectStore("files");
                        store.put({ id: file, blob });
                        console.log(
                            `[PMLX Updater] Successfully downloaded and stored ${file}`
                        );
                    };
                } catch (error) {
                    console.error(
                        `[PMLX Updater] Error downloading ${file}:`,
                        error
                    );
                }
            }

            /**
             * Downloads the necessary files for the game.
             * @returns {Promise<boolean>} True if the download was successful, false if no update was needed.
             */
            async function downloadFiles() {
                if (!(await needsUpdate())) {
                    console.log("[PMLX Updater] PMLX is already up to date.");
                    return false;
                }

                // for each file in the list, fetch it and store it in indexedDB
                for (const file of stuffToDownload) {
                    await downloadFile(file);
                }
                return true;
            }

            (async () => {
                const needsUpdate = await downloadFiles();

                if (needsUpdate) {
                    const request = indexedDB.open("pmlx", 1);
                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(["files"], "readonly");
                        const store = transaction.objectStore("files");
                        const getRequest = store.get("patches-index.json");
                        getRequest.onsuccess = (event) => {
                            const patchesIndex = event.target.result;
                            if (patchesIndex) {
                                console.log(
                                    `[PMLX Updater] Successfully retrieved patches-index.json`
                                );
                                const patches = JSON.parse(
                                    patchesIndex.blob.text()
                                );
                                for (const patch of patches) {
                                    downloadFile(
                                        `patches/${patch.split(".").slice(0, -1).join(".")}`
                                    );
                                }
                            } else {
                                console.error(
                                    `[PMLX Updater] Failed to retrieve patches-index.json`
                                );
                            }
                        };
                    };
                }
            })();
        </script>
    </head>
</html>
